function Formula(e,t){this._formula=e,this._elements=[],this._operands=[],this._operators=[],this._variables=t||[]}function FormulaFactory(){this.createFormula=function(e,t){return console.log("Creating new formula..."),new Formula(e,t)}}Formula.prototype.init=function(){this.formulaFactory=new FormulaFactory,this.parseMathFormula(this._formula),console.log("New formula created"),console.log(this)},Formula.prototype.parseMathFormula=function(e){this.getElementsRecursive(e),this.getOperands(),this.getOperators()},Formula.prototype.getElementsRecursive=function(e){for(var t,r=!1,i=0;i<e.length;i++){if(" "===e[i]&&!1===r&&" "!==e[i+1]){t=i;break}if("("!==e[i]){if(r&&")"===e[i]){t=i+1;break}}else r=!0}t>=0?(this._elements.push(e.slice(0,t).trim()),this.getElementsRecursive(e.slice(t+1).trim())):this._elements.push(e.slice(0))},Formula.prototype.getOperands=function(){for(var e=0;e<this._elements.length;e++)e%2==0&&this._operands.push(this._elements[e])},Formula.prototype.getOperators=function(){for(var e=0;e<this._elements.length;e++)e%2!=0&&this._operators.push(this._elements[e])},Formula.prototype.execute=function(){if(1===this._elements.length&&1===this._operands.length)return parseFloat(this._operands[0]);var e=this;this._operands.forEach(function(t,r){if("("===t.charAt(0)&&")"===t.slice(-1)){t=t.slice(1,-1).trim();var i=e.formulaFactory.createFormula(t,e._variables);i.init();var n=i.execute();e._elements[e._elements.indexOf(e._operands[r])]=n,e._operands[r]=n}});for(var t=0;t<this._elements.length;t++)if(t%2!=0){if(!(o=this.isOperator(this._elements[t])))return console.log("Operator is not defined"),!1;if("*"===o||"/"===o){var r=this.getOperatorFunction(o),i=e.execOperatorFunction(this._elements[t-1],this._elements[t+1],r);return this._elements.splice(t-1,3),this._elements.splice(t-1,0,i),(s=e.formulaFactory.createFormula(this._elements.join(" "),e._variables)).init(),s.execute()}}for(var n=0;n<this._elements.length;n++)if(n%2!=0){var o=this.isOperator(this._elements[n]);if(!o)return console.log("Operator is not defined"),!1;if("+"===o||"-"===o){var r=this.getOperatorFunction(o),i=e.execOperatorFunction(this._elements[n-1],this._elements[n+1],r);this._elements.splice(n-1,3),this._elements.splice(n-1,0,i);var s=e.formulaFactory.createFormula(this._elements.join(" "),e._variables);return s.init(),s.execute()}}},Formula.prototype.execOperatorFunction=function(e,t,r){return isNaN(e)&&!(e=this.isVariable(e))?(console.log("error, variable not defined"),!1):isNaN(t)&&!(t=this.isVariable(t))?(console.log("error, variable not defined"),!1):r(e,t)},Formula.prototype.getOperatorFunction=function(e){switch(e){case"*":return function(e,t){return e*t};case"+":return function(e,t){return e+t};case"/":return function(e,t){return e/t};case"-":return function(e,t){return e-t};case"%":return function(e,t){return e%t}}},Formula.prototype.isOperator=function(e){var t=["+","-","*","/","%"];return-1!==t.indexOf(e)&&t[t.indexOf(e)]},Formula.prototype.isVariable=function(e){for(var t=0;t<this._variables.length;t++)if(this._variables[t].name===e)return this._variables[t].value;return!1};