/**
 * mathformulaparser - Script to parse and execute custom math formulas
 * @version v1.0.0
 * @link https://github.com/josefano/mathFormulaParser#readme
 * @author Jose Fano
 * @license ISC
 * @lastModified Thu Sep 21 2017 16:59:14 GMT-0400 (Eastern Daylight Time)
 */
function Formula(e,t){this._id=this.getRandomId(),this._formula=e,this._elements=[],this._operands=[],this._operators=[],this._variables=t||[],this._formulaFactory=new FormulaFactory,this._execHistory=[],this._state=[]}function FormulaFactory(){this.createFormula=function(e,t){return console.log("Creating new formula..."),new Formula(e,t)}}Formula.prototype.init=function(){this.parseMathFormula(this._formula),console.log("New formula created"),console.log(this)},Formula.prototype.parseMathFormula=function(e){this.getElementsRecursive(e),this.getOperands(),this.getOperators()},Formula.prototype.getElementsRecursive=function(e){for(var t=-1,r=!1,i=0;i<e.length;i++){if(" "===e[i]&&!1===r&&" "!==e[i+1]){t=i;break}if("("!==e[i]){if(r&&")"===e[i]){t=i+1;break}}else r=!0}if(t>=0){this._elements.push(e.slice(0,t).trim());var o=e.slice(t+1).trim();o.length&&this.getElementsRecursive(o)}else this._elements.push(e.slice(0).trim())},Formula.prototype.getOperands=function(){for(var e=0;e<this._elements.length;e++)e%2==0&&this._operands.push(this._elements[e])},Formula.prototype.getOperators=function(){for(var e=0;e<this._elements.length;e++)e%2!=0&&this._operators.push(this._elements[e])},Formula.prototype.execute=function(){if(console.log("Executing formula..."),1===this._elements.length&&1===this._operands.length){var e=parseFloat(this._operands[0]);return console.log("The final result:"),console.log(e),e}var t=this.execFirstOrderOperations();t.execSecondOrderOperations(),t.execThirdOrderOperations(),t.execFourthOrderOperations()},Formula.prototype.execOperatorFunction=function(e,t,r){return isNaN(e)&&!(e=this.isVariable(e))?(console.log("error, variable not defined"),!1):isNaN(t)&&!(t=this.isVariable(t))?(console.log("error, variable not defined"),!1):r(e,t)},Formula.prototype.getOperatorFunction=function(e){switch(e){case"*":return function(e,t){return e*t};case"+":return function(e,t){return e+t};case"/":return function(e,t){return e/t};case"-":return function(e,t){return e-t};case"%":return function(e,t){return e%t};case"^":return function(e,t){return Math.pow(e,t)}}},Formula.prototype.isOperator=function(e){var t=["+","-","*","/","%","^"];return-1!==t.indexOf(e)&&t[t.indexOf(e)]},Formula.prototype.isVariable=function(e){for(var t=0;t<this._variables.length;t++)if(this._variables[t].name===e)return this._variables[t].value;return!1},Formula.prototype.addVariable=function(e){if(!(e&&e.name&&e.type&&e.value))return!1;this._variables.push(e)},Formula.prototype.execFirstOrderOperations=function(){for(var e=this._elements,t=!1,r=0;r<this._operands.length;r++){var i=this._operands[r];if("("===i.charAt(0)&&")"===i.slice(-1)){t=!0,i=i.slice(1,-1).trim();var o=this._formulaFactory.createFormula(i,this._variables);o.init();var s=o.execute();e[this._elements.indexOf(this._operands[r])]=s}}if(t){var n=this._formulaFactory.createFormula(e.join(" "),this._variables);return n.init(),this.addState(n),n}return this},Formula.prototype.execSecondOrderOperations=function(){for(var e=0;e<this._elements.length;e++)if(e%2!=0){var t=this.isOperator(this._elements[e]);if(t){if("^"===t){var r=this.getOperatorFunction(t),i=this.execOperatorFunction(this._elements[e-1],this._elements[e+1],r),o=this._elements;o.splice(e-1,3),o.splice(e-1,0,i);var s=this._formulaFactory.createFormula(o.join(" "),this._variables);return s.init(),this.addState(s),s.execute()}break}return console.log("Operator is not defined"),!1}},Formula.prototype.execThirdOrderOperations=function(){for(var e=0;e<this._elements.length;e++)if(e%2!=0){var t=this.isOperator(this._elements[e]);if(t){if("*"===t||"/"===t){var r=this.getOperatorFunction(t),i=this.execOperatorFunction(this._elements[e-1],this._elements[e+1],r),o=this._elements;o.splice(e-1,3),o.splice(e-1,0,i);var s=this._formulaFactory.createFormula(o.join(" "),this._variables);return s.init(),this.addState(s),s.execute()}break}return console.log("Operator is not defined"),!1}},Formula.prototype.execFourthOrderOperations=function(){for(var e=0;e<this._elements.length;e++)if(e%2!=0){var t=this.isOperator(this._elements[e]);if(t){if("+"===t||"-"===t){var r=this.getOperatorFunction(t),i=this.execOperatorFunction(this._elements[e-1],this._elements[e+1],r),o=this._elements;o.splice(e-1,3),o.splice(e-1,0,i);var s=this._formulaFactory.createFormula(o.join(" "),this._variables);return s.init(),this.addState(s),s.execute()}break}return console.log("Operator is not defined"),!1}},Formula.prototype.getRandomId=function(){return(new Date).getUTCMilliseconds()},Formula.prototype.addState=function(e){if(e instanceof Formula==!1)return!1;this._state.push(e)};